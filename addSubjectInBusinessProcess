Расширение
Объект БизнесПроцесс-Утверждение
ФормаБизнесПроцесса
МодульФормы
&НаСервере
Процедура ОК_ПриСозданииНаСервереПеред(Отказ, СтандартнаяОбработка)
	ВходящиеДокументыЭДО 			= вега_ДиадокСервер.СостояниеДокумента(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭтотОбъект.Объект.Предметы[0].Предмет, "Ссылка"));
	ПризнакВходящегоДокументаЭДО	= ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(ВходящиеДокументыЭДО, "ЭтоВходящее"); 
	
	Если Не ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭтотОбъект.Объект.Шаблон, "вега_ОтправитьПоЭДО") = Неопределено Тогда 
		ШаблонСПризнакомОтправитьПоЭДО =  ОбщегоНазначения.ЗначениеРеквизитаОбъекта(ЭтотОбъект.Объект.Шаблон, "вега_ОтправитьПоЭДО");
		Если ПризнакВходящегоДокументаЭДО Тогда 
			Если НЕ ШаблонСПризнакомОтправитьПоЭДО Тогда
				Отказ = Истина;	
			Иначе
				УИДПакетаВходящиеДокументыЭДО = ПолучитьСоставПакетовДокументовЭДО(ОбщегоНазначенияКлиентСервер.СвойствоСтруктуры(ВходящиеДокументыЭДО, "ТекущийЭД"));
				Если НЕ УИДПакетаВходящиеДокументыЭДО = Неопределено Тогда 
						ВнутренниеДок = СвязиДокументов.ПолучитьСвязанныеДокументы(ОбщегоНазначения.ЗначениеРеквизитаОбъекта(
										ЭтотОбъект.Объект.Предметы[0].Предмет, "Ссылка") , Справочники.ТипыСвязей.НайтиПоНаименованию("Входит в пакет ЭДО"));
						Для каждого Строка Из ВнутренниеДок Цикл
							Мультипредметность.ДобавитьПредмет(Объект, Строка);
						КонецЦикла;	   
						ИсходныйНомерСтроки = 1;
						Для каждого Строка Из Объект.Предметы Цикл
							Строка.ИсходноеИмяПредмета	= Строка.ИмяПредмета;
							Строка.Картинка				= 1;
							Строка.Описание				= Строка.Предмет;	
						КонецЦикла;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;    
	КонецЕсли;
КонецПроцедуры

Функция ПолучитьСоставПакетовДокументовЭДО(ЭлектронныйДокумент) Экспорт
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СоставПакетовДокументовЭДО.ИдентификаторПакета КАК ИдентификаторПакета,
		|	СоставПакетовДокументовЭДО.ЭлектронныйДокумент
		|ИЗ
		|	РегистрСведений.СоставПакетовДокументовЭДО КАК СоставПакетовДокументовЭДО
		|ГДЕ
		|	СоставПакетовДокументовЭДО.ЭлектронныйДокумент = &ЭлектронныйДокумент
		|	";
	
	Запрос.УстановитьПараметр("ЭлектронныйДокумент", ЭлектронныйДокумент);
	
	РезультатЗапроса = Запрос.Выполнить().Выгрузить();
	УИДПакета = Неопределено;
	Если НЕ РезультатЗапроса.Количество() = 0 Тогда
	    УИДПакета = РезультатЗапроса[0].ИдентификаторПакета;
	КонецЕсли;
	
	Возврат УИДПакета;
КонецФункции
